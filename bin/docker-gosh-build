#!/bin/bash

error() {
    echo "$@" 1>&2
}

{ # redirrect output to stderr

    BUILD_DIR=$(pwd)/.build

    rm -rf "$BUILD_DIR"
    mkdir "$BUILD_DIR"

    cd "$BUILD_DIR" || exit 1

    GOSH_REPO="${*: -1}"
    set -- "${@:1:$(($# - 1))}"
    echo "cloning GOSH repo: $GOSH_REPO"

    git clone "$GOSH_REPO" repo
    # TODO: check out a specific commit

    cd repo || exit 1

    RUST_LOG=info
    export RUST_LOG

    if ! gosh-builder-cli --validate; then
        exit 2
    fi

} 1>&2

echo "your-image-tag"
